name: Build Yass Reloaded

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  JAVA_VERSION: "21"
  JAVAFX_VERSION: "21.0.2"

jobs:
  
  # -------------------------
  # WINDOWS x64
  # -------------------------
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Jazzy JAR
        run: mvn install:install-file -DgroupId=com.swabunga -DartifactId=jazzy -Dversion=1.0 -Dpackaging=jar -Dfile=lib/jazzy.jar

      - name: Download JavaFX
        run: |
          curl -L -o javafx.zip https://download2.gluonhq.com/openjfx/${{ env.JAVAFX_VERSION }}/openjfx-${{ env.JAVAFX_VERSION }}_windows-x64_bin-sdk.zip
          tar -xf javafx.zip

      - name: Build JAR
        run: mvn clean package

      - name: Build Runtime
        run: |
          jlink --module-path "%JAVA_HOME%\jmods;openjfx-${{ env.JAVAFX_VERSION }}\lib" --add-modules java.base,java.desktop,javafx.swing,javafx.media --output yass-runtime

      - name: Build Installer
        run: |
          jpackage --input target --name "Yass Reloaded" --main-jar Yass-Reloaded.jar --runtime-image yass-runtime --type exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Yass-Windows
          path: "*.exe"
  
  
  # -------------------------
  # LINUX x64
  # -------------------------
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Jazzy JAR
        run: mvn install:install-file -DgroupId=com.swabunga -DartifactId=jazzy -Dversion=1.0 -Dpackaging=jar -Dfile=lib/jazzy.jar

      - name: Download JavaFX
        run: |
          curl -L -o javafx.tar.gz https://download2.gluonhq.com/openjfx/${{ env.JAVAFX_VERSION }}/openjfx-${{ env.JAVAFX_VERSION }}_linux-x64_bin-sdk.tar.gz
          tar -xzf javafx.tar.gz

      - name: Build JAR
        run: mvn clean package

      - name: Build Runtime
        run: |
          jlink --module-path "$JAVA_HOME/jmods:openjfx-${{ env.JAVAFX_VERSION }}/lib" --add-modules java.base,java.desktop,javafx.swing,javafx.media --output yass-runtime

      - name: Build Installer
        run: |
          jpackage --input target --name "Yass Reloaded" --main-jar Yass-Reloaded.jar --runtime-image yass-runtime --type deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Yass-Linux
          path: "*.deb"
  
  
  # -------------------------
  # macOS aarch64 (Apple Silicon)
  # -------------------------
  build-macos-aarch64:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Jazzy JAR
        run: mvn install:install-file -DgroupId=com.swabunga -DartifactId=jazzy -Dversion=1.0 -Dpackaging=jar -Dfile=lib/jazzy.jar

      - name: Download JavaFX
        run: |
          curl -L -o javafx.tar.gz https://download2.gluonhq.com/openjfx/${{ env.JAVAFX_VERSION }}/openjfx-${{ env.JAVAFX_VERSION }}_macos-aarch64_bin-sdk.tar.gz
          tar -xzf javafx.tar.gz

      - name: Build JAR
        run: mvn clean package

      - name: Build Runtime
        run: |
          jlink --module-path "$JAVA_HOME/jmods:openjfx-${{ env.JAVAFX_VERSION }}/lib" --add-modules java.base,java.desktop,javafx.swing,javafx.media --output yass-runtime

      - name: Build App Image
        run: |
          jpackage --input target --name "Yass Reloaded" --main-jar Yass-Reloaded.jar --runtime-image yass-runtime --type app-image

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Yass-macOS-aarch64
          path: "*.app"

name: Build Yass Reloaded

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  JAVA_VERSION: "21"
  JAVAFX_VERSION: "21.0.2"

jobs:
  
  # -------------------------
  # WINDOWS x64
  # -------------------------
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Build JAR
        run: mvn clean package

      - name: Download JavaFX JMODs
        run: |
          curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_windows-x64_bin-jmods.zip
          powershell -Command "Expand-Archive -Path javafx-jmods.zip -DestinationPath openjfx-21.0.2"
          
      - name: Build Runtime & Installer
        run: |
          jlink --module-path "%JAVA_HOME%\jmods;openjfx-21.0.2" --add-modules java.base,java.desktop,javafx.swing,javafx.media --output yass-runtime
          jpackage --input target --name "Yass Reloaded" --main-jar Yass-Reloaded.jar --runtime-image yass-runtime --type exe

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: Yass-Windows
          path: '*.exe'

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Build JAR
        run: mvn clean package

      - name: Download JavaFX JMODs
        run: |
          curl -L -o javafx-jmods.tar.gz https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_linux-x64_bin-jmods.tar.gz
          tar -xzf javafx-jmods.tar.gz -C openjfx-21.0.2
          # Die JMODs liegen jetzt in openjfx-21.0.2/lib

      - name: Build Runtime & Installer
        run: |
          jlink --module-path "$JAVA_HOME/jmods:openjfx-21.0.2/lib" \
                --add-modules java.base,java.desktop,javafx.swing,javafx.media \
                --output yass-runtime
          jpackage --input target --name "Yass Reloaded" --main-jar Yass-Reloaded.jar \
                   --runtime-image yass-runtime --type deb

      - name: Upload Linux Installer
        uses: actions/upload-artifact@v4
        with:
          name: Yass-Linux
          path: '*.deb'

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 21

      - name: Build JAR
        run: mvn clean package

      - name: Download JavaFX JMODs
        run: |
          curl -L -o javafx-jmods.tar.gz https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_macos-x64_bin-jmods.tar.gz
          mkdir -p openjfx-21.0.2
          tar -xzf javafx-jmods.tar.gz -C openjfx-21.0.2

      - name: Build Runtime & Installer
        run: |
          jlink \
            --module-path "$JAVA_HOME/jmods:openjfx-21.0.2" \
            --add-modules java.base,java.desktop,javafx.swing,javafx.media \
            --strip-debug --no-header-files --no-man-pages \
            --output yass-runtime

          jpackage \
            --input target \
            --name "Yass Reloaded" \
            --main-jar Yass-Reloaded.jar \
            --runtime-image yass-runtime \
            --type app-image

      - name: Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: Yass-macOS
          path: '*.app'

  build-macos-aarch64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 21

      - name: Build JAR
        run: mvn clean package

      - name: Download JavaFX JMODs (aarch64)
        run: |
          curl -L -o javafx-jmods.tar.gz https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_macos-aarch64_bin-jmods.tar.gz
          mkdir -p openjfx-21.0.2
          tar -xzf javafx-jmods.tar.gz -C openjfx-21.0.2

      - name: Build Runtime & Installer (macOS aarch64)
        run: |
          jlink \
            --module-path "$JAVA_HOME/jmods:openjfx-21.0.2" \
            --add-modules java.base,java.desktop,javafx.swing,javafx.media \
            --strip-debug --no-header-files --no-man-pages \
            --output yass-runtime

          jpackage \
            --input target \
            --name "Yass Reloaded" \
            --main-jar Yass-Reloaded.jar \
            --runtime-image yass-runtime \
            --type app-image

      - name: Upload macOS aarch64 Installer
        uses: actions/upload-artifact@v4
        with:
          name: Yass-macOS-aarch64
          path: '*.app'
